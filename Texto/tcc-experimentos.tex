\chapter{EXPERIMENTOS E RESULTADOS}
\label{experimentos}

\textcolor{red}{Explicar melhor os experimentos, elaborar melhor os nomes dos testes (EXPLICAÇÃO CONFUSA)}

Os experimentos usam um modelo digital da arena física presente no laboratório da sala K4-04 da instituição. O motivo de esta arena ter sido escolhida se deu por conta da comparação que futuramente pode ser realizada entre os testes virtuais e reais. 

Foram feitos cinco experimentos com resultados satisfatórios, e um que acabou não fornecendo os resultados devidos por conta de instabilidades. 
\textcolor{blue}{
Todos os testes foram feitos em um computador com as seguintes especificações:
Linux Jammy 22.04 com um processador AMD Ryzen 5 1600X (12 Cores, 3.6GHz), 16 GB RAM DDR4.
Todas as ferramentas e configurações destas estão disponíveis em um playbook, no repositório.
A imagem Docker utilizada no projeto se baseia na imagem usada para ROS 2 Humble, presente no repositório oficial da robotis\footnote{(https://github.com/ROBOTIS-GIT/turtlebot3/tree/main/docker/humble)}, modificada para ter as configurações e arquivos necessários.
}
O primeiro deles (Setup) teve testes iniciais para confirmar o comportamento do ROS 2 dentro de um container Docker. 
O segundo experimento (Base), usaram-se simulações utilizando o mapa base sem patrulheiros.
O terceiro experimento (Patrulheiros) usou simulações utilizando o mapa base com patrulheiros.
O quarto experimento (Base + Docker) usou simulações utilizando o mapa base sem patrulheiros, com a stack nav2 e rviz dentro de um container Docker.
No quinto experimento (Patrulheiros + Docker), usaram-se simulações utilizando o mapa base com patrulheiros, com a stack nav2 e rviz dentro de um container Docker.
Foram também realizados experimentos usando arenas com labirintos para testar a navegação do robô, \textcolor{red}{mas a navegação acabou tendo problemas em experimentos com e sem Docker, dando a indicar que é um problema com o mapa, ou com as bibliotecas ROS 2 utilizadas, e não com a conteinerização.} \textcolor{green}{EXPLICAR PROBLEMA}

\section{CONTEÚDO REPOSITÓRIO}
\textcolor{blue}{
O repositório GitHub criado para este projeto possui várias ferramentas que podem ser utilizadas para facilitar a reprodução dos testes executados. 
O README contém um overview de como instalar o projeto e utilizar os scripts presentes no projeto. 
Foi criado um playbook ansible (playbook.yaml) para facilitar a configuração e instalação do Docker, ROS 2 Humble, Gazebo Classic e suas dependências. 
Foram também criados vários arquivos .sh para facilitar a reprodução dos testes, por garantir que os comandos corretos serão executados na sequência correta, sem necessidade de intervenção do usuário, onde os arquivos “inicioRapido” possuem os comandos utilizados para cada um dos testes feitos para este projeto. 
Os arquivos .sh na pasta /scripts possuem funcionalidades genéricas criadas para os testes, como a inicialização do nmon (iniciarNmon.sh), mover o robô ao inicializar rviz e mandar uma mensagem de goal (moverMain.sh), entre outras. 
No pacote ROS 2 criado (localizado em /tcc) está uma versão modificada do arquivo turtlebot3\_absolute\_move.py (turtlebot3\_absolute\_move\_Arena.py, localizada em /tcc/tcc), utilizado na movimentação dos robôs patrulheiros. 
Esta modificação faz com que os robôs inicializados entrem em um loop infinito de movimentação entre 2 pontos especificados, lógica utilizada no script rotasRobos.sh. 
Há também uma versão modificada de multi\_robot\_Arena.launch.py com as posições iniciais dos robôs patrulheiros e turtlebot3\_world.launch.py (turtlebot3\_Arena.launch.py), que permite carregar o robô em uma posição fixa em qualquer mapa, contanto que o nome seja especificado e o arquivo .world presente em /tcc/worlds.
}

\section{RESULTADOS SETUP}
Foram feitos testes para implementar a parte simulada proposta, foi utilizado o manual \cite{turtlebot3_manual} e pacotes\footnote{(https://github.com/ROBOTIS-GIT/turtlebot3)} disponíveis pelo grupo ROBOTIS, tornando o desenvolvimento desta parte rápido. A utilização e desenvolvimento dos projetos ROS 2 dentro do Docker foi facilitada pela utilização de workflows no GitHub, onde as imagens de teste foram automaticamente construídas e publicadas como pacotes no repositório, o que reduziu o tempo do processo de construir as imagens localmente, que demorava mais de 20 minutos para no máximo 5 minutos, além de também as disponibilizar para outros usarem.

Houve certas dificuldades para integrar o ROS 2 dentro do contêiner Docker com o ROS 2 nativo, que lidaria com a simulação Gazebo. 
\textcolor{red}{Foi descoberto que o FastDDS (middleware utilizado por padrão pelo ROS 2 Humble) não interage de forma consistente com Docker. Ele era capaz de compartilhar os tópicos entre os ambientes, mas causava falha na publicação e recebimento de mensagens, não mostrando nenhuma.}\textcolor{blue}{ADICIONAR IMAGEM DE TESTE SETUP (TestePadraoFalha;Desc: Terminal na esquerda host com implementação default (FastDDS), Terminal na direita docker com implementação default (FastDDS) )} \textcolor{green}{DESENVOLVER}

Para solucionar isso, o FastDDS foi substituído por outro middleware disponível para ROS 2 Humble, CycloneDDS, o qual foi utilizado especificamente no container Docker.
\textcolor{blue}{(TesteCycloneSucesso; Terminal na esquerda host com implementação default (FastDDS), Terminal na direita docker com implementação rmw\_cyclonedds\_cpp)}

\section{TESTES BASE}
Foram feitos testes para adquirir os dados de desempenho das simulações sem Docker, utilizando a arena base sem patrulheiros. Estes testes consistiam em fazer o robô percorrer um trajeto de uma ponta até a outra da arena. Durante a execução, foi utilizado o software Nmon para verificar o desempenho de CPU, memória RAM e rede, e assim armazenar os dados. Os testes com a arena base + docker, o robô realizou o mesmo trajeto que o teste anterior de seguir de uma ponta da arena até a outra. Os testes foram realizados enquanto o software Nmon verificava o desempenho do sistema.


\section{TESTES PATRULHEIROS}
Neste teste foram posicionados robôs patrulheiros que percorriam um 
\textcolor{red}{simples trajeto} \textcolor{blue}{trajeto de linha reta onde saiam e retornavam as seus pontos de origem}
(Figura \ref{fig:AP}) para servir de obstáculo para o robô que deveria percorrer o mesmo trajeto de antes. Novamente foi utilizada a arena base, e sem o uso do docker. Foram feitos testes para adquirir os dados de desempenho de simulações com Docker, utilizando a arena base com patrulheiros.

\begin{figure}[htb]
    \caption{Arena Patrulheiros}
    \includegraphics[width=0.3\linewidth]{Figures/Arena/ArenaPatrulheiros.png}
    \caption*{Fonte: Autores}
    \caption*{Legenda: As retas em vemelho são os trajetos realizados pelos patrulheiros}
    \label{fig:AP}
\end{figure}

\section{TESTES LABIRINTOS}
Inicialmente, foram realizados testes sem patrulheiros, com e sem o uso de docker, em duas arenas com labirintos (Figuras \ref{fig:AL1} e \ref{fig:AL2}) como obstáculo para o robô. Os labirintos foram desenvolvidos utilizando placas, que são os obstáculos presentes na arena física da K4-04, respeitando o espaço da arena, placas e possíveis posições. Estes testes acabaram por falhar, por conta da inconsistência da navegação do teste, tendo casos em que a navegação falhava no meio do caminho, ou outros em que 
\textcolor{red}{eram necessárias entre 4 - 12 recuperações} \textcolor{blue}{era necessário refazer o teste de 4 a 12 vezes para o robô conseguir realizar o trajeto completo}. 
Por conta disso, os testes com os patrulheiros não tiveram resultados consistentes em relação as métricas que seriam medidas.

\begin{figure}[htb]
    \caption{Arena Labirinto 1}
    \includegraphics[width=0.3\linewidth]{Figures/Arena/ArenaLabirinto1.png}
    \caption*{Fonte: Autores}
    \label{fig:AL2}
\end{figure}

\begin{figure}[htb]
    \caption{Arena Labirinto 2}
    \includegraphics[width=0.3\linewidth]{Figures/Arena/ArenaLabirinto2.png}
    \caption*{Fonte: Autores}
    \label{fig:AL1}
\end{figure}

\section{RESULTADOS}
Os resultados obtidos foram salvos e utilizados em gráficos gerados pela biblioteca Pandas. Os dados apresentados foram a porcentagem do uso do sistema (CPU, memória RAM e Rede), com relação ao passo executado no Nmon. Estes gráficos revelam que a utilização do Docker afetou o desempenho, mas de uma maneira mínima. 
Nos gráficos de CPU (Figura \ref{fig:GACPU}), pode-se ver que a mesma acabou por ser mais exigida quando não se utilizava o Docker, por volta de 1\% da média de uso. 
Nos gráficos de memória RAM (Figura \ref{fig:GAMEM}), pode-se ver que a diferença do uso é de cerca de 500 MB a mais quando se usa o Docker. Este aumento ocorreu por conta da necessidade do Docker de subir o container.
Nos gráficos de rede (Figura \ref{fig:GANET}), pode-se ver que o uso do Docker é mais evidente, tendo um pico inicial muito alto, mas que diminui logo em seguida. Este aumento ocorreu por conta da necessidade do Docker em se comunicar, via rede, com os outros tópicos utilizados pelo host.  

Os testes nas arenas com patrulheiros se demonstraram muito semelhantes aos testes das arenas bases em termos de gráficos, mas os mesmos utilizaram bem mais recursos do sistema.
Nos gráficos de CPU (Figura \ref{fig:GPCPU}), pode-se ver que foi exigido bem mais da CPU do sistema. Enquanto na arena base era exigido até 30\% da CPU, com os patrulheiros foi exigido 50\%, nesta arena a falta do Docker exigiu mais do sistema, enquanto com o Docker houve poucos picos de uso. 
Nos gráficos de memória RAM (Figura \ref{fig:GPMEM}) se pode ver que se diferenciaram no uso de cerca de 500 MB a mais no uso do Docker, semelhante à arena base, exigindo mais da memória no geral do teste.
Nos testes de rede (Figura \ref{fig:GPNET}), pode-se ver que o uso do Docker é novamente mais evidente, tendo um pico de uso muito alto, que logo diminuiu, mas que ainda ficou mais acima dos testes sem Docker. 

Com relação aos testes com os labirintos, os mesmos se demonstraram instáveis, então não foram testados por conta da quantidade de testes aleatórios que precisavam ser feitos para ter um teste que gerasse bons resultados para serem observados. Porém a instabilidade foi a mesma com e sem o uso do Docker.

Os dados apresentados são a média e desvio padrão das 30 execuções dos experimentos que foram descritos na seção anterior e \textcolor{red}{exibem} \textcolor{green}{DESENVOLVER}

\textcolor{red}{EXPLICAR MELHOR OS GRÁFICOS}
\begin{figure}[htb]
    \caption{Gráfico da métrica de porcentagem de uso total de CPU dos testes na arena base com e sem docker com banda de erro ao tempo, cada Step é 1 segundo.}
    \includegraphics[width=0.7\linewidth]{Figures/Graficos/arena_cpu.png}
    \caption*{Fonte: Autores}
    \label{fig:GACPU}
\end{figure}

\begin{figure}[htb]
    \caption{Gráfico da métrica de porcentagem de uso total de memória RAM dos testes na arena base com e sem docker com banda de erro ao tempo, cada Step é 1 segundo.}
    \includegraphics[width=0.7\linewidth]{Figures/Graficos/arena_mem.png}
    \caption*{Fonte: Autores}
    \label{fig:GAMEM}
\end{figure}

\begin{figure}[htb]
    \caption{Gráfico da métrica de uso total de Rede em kb/s dos testes na arena base com e sem docker com banda de erro ao tempo, cada Step é 1 segundo.}
    \includegraphics[width=0.7\linewidth]{Figures/Graficos/arena_net.png}
    \caption*{Fonte: Autores}
    \label{fig:GANET}
\end{figure}

\begin{figure}[htb]
    \caption{Gráfico da métrica de porcentagem de uso total de CPU dos testes na arena com robôs patrulheiros, com e sem docker com banda de erro ao tempo, cada Step é 1 segundo.}
    \includegraphics[width=0.7\linewidth]{Figures/Graficos/patrulha_cpu.png}
    \caption*{Fonte: Autores}
    \label{fig:GPCPU}
\end{figure}

\begin{figure}[htb]
    \caption{Gráfico da métrica de porcentagem de uso total de memória RAM dos testes na arena com robôs patrulheiros, com e sem docker com banda de erro ao tempo, cada Step é 1 segundo.}
    \includegraphics[width=0.7\linewidth]{Figures/Graficos/patrulha_mem.png}
    \caption*{Fonte: Autores}
    \label{fig:GPMEM}
\end{figure}

\begin{figure}[htb]
    \caption{Gráfico da métrica de uso total de Rede em kb/s dos testes na arena com robôs patrulheiros, com e sem docker com banda de erro ao tempo, cada Step é 1 segundo.}
    \includegraphics[width=0.7\linewidth]{Figures/Graficos/patrulha_net.png}
    \caption*{Fonte: Autores}
    \label{fig:GPNET}
\end{figure}